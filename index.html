<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IOT Controller & Scheduler</title>
  <style>
    :root {
      --primary: #4a6fa5;
      --primary-light: #6b8cc6;
      --primary-dark: #3a5a84;
      --off-state: #e74c3c;
      --on-state: #2ecc71;
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #333333;
      --text-light: #777777;
      --border: #e1e4e8;
      --shadow: rgba(0, 0, 0, 0.08);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 450px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 6px 16px var(--shadow);
      margin-bottom: 20px;
    }
    
    h1 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 1.8rem;
    }
    
    .subtitle {
      text-align: center;
      color: var(--text-light);
      margin-bottom: 24px;
      font-size: 0.9rem;
    }
    
    .section-title {
      font-size: 1.1rem;
      color: var(--primary);
      margin: 20px 0 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
    }
    
    .section-title svg {
      margin-right: 10px;
      width: 20px;
      height: 20px;
    }
    
    /* Grid layout untuk lampu */
    .lampu-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .lampu-item {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid var(--border);
    }
    
    .lampu-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow);
    }
    
    .lampu-label {
      font-weight: 500;
      margin-bottom: 12px;
      text-align: center;
      font-size: 0.95rem;
    }
    
    .status-container {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .led-icon {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
      transition: all 0.3s ease;
    }
    
    .led-icon.on {
      background-color: var(--on-state);
      box-shadow: 0 0 8px var(--on-state);
    }
    
    .led-icon.off {
      background-color: var(--off-state);
    }
    
    .status-text {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    
    .toggle-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
      font-weight: 500;
    }
    
    .toggle-btn:hover {
      background: var(--primary-light);
    }
    
    .toggle-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Form jadwal */
    .schedule-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .time-input-group {
      display: flex;
      flex-direction: column;
    }
    
    .time-input-group label {
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: var(--text-light);
    }
    
    input[type="time"] {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: inherit;
      background: var(--bg);
    }
    
    .save-btn {
      grid-column: span 2;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 500;
    }
    
    .save-btn:hover {
      background: var(--primary-light);
    }
    
    /* Status koneksi */
    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
      transition: background 0.3s;
    }
    
    .connection-dot.connected {
      background: var(--on-state);
      box-shadow: 0 0 6px var(--on-state);
    }
    
    .connection-dot.disconnected {
      background: var(--off-state);
    }
    
    /* Log */
    #log {
      border: 1px solid var(--border);
      padding: 16px;
      height: 160px;
      overflow-y: auto;
      border-radius: 12px;
      font-size: 0.85rem;
      background: #fafafa;
      margin-top: 20px;
    }
    
    .log-entry {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
    }
    
    .log-time {
      color: var(--text-light);
      font-size: 0.8rem;
      margin-right: 10px;
      min-width: 60px;
    }
    
    .log-message {
      color: var(--text);
      flex: 1;
    }
    
    /* Responsivitas */
    @media (max-width: 480px) {
      body {
        padding: 15px;
      }
      
      .card {
        padding: 20px;
      }
      
      .lampu-grid {
        grid-template-columns: 1fr;
      }
      
      .schedule-form {
        grid-template-columns: 1fr;
      }
      
      .save-btn {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>WebRol IOT</h1>
    <p class="subtitle">Kontrol Semua Device Berdasarkan Jadwal</p>

    <!-- Kontrol Lampu -->
    <div class="section-title">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
      </svg>
      Kontrol Lampu
    </div>
    <div class="lampu-grid" id="lampu-container"></div>

    <!-- Jadwal Global -->
    <div class="section-title">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Jadwal Global
    </div>
    <div class="schedule-form">
      <div class="time-input-group">
        <label for="global-on-time">Menyala</label>
        <input type="time" id="global-on-time">
      </div>
      <div class="time-input-group">
        <label for="global-off-time">Mati</label>
        <input type="time" id="global-off-time">
      </div>
      <button class="save-btn" onclick="simpanJadwal()">Simpan Jadwal</button>
    </div>

    <!-- Status Koneksi -->
    <div class="connection-status">
      <div class="connection-dot disconnected" id="connection-dot"></div>
      <span id="connection-status">Menghubungkan ke broker...</span>
    </div>

    <!-- Log -->
    <div class="section-title">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      Log Aktivitas
    </div>
    <div id="log"></div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const broker = 'wss://broker.hivemq.com:8884/mqtt';
    const client = mqtt.connect(broker, { 
      clientId: 'web_' + Math.random().toString(16).substr(2,8),
      reconnectPeriod: 5000
    });

    const lampus = [
      { id: 1, label: 'Ruang Makan', topicCtrl: 'coba/lampu1', topicStatus: 'status/lampu1', state: null },
      { id: 2, label: 'Ruang Tamu', topicCtrl: 'coba/lampu2', topicStatus: 'status/lampu2', state: null },
      { id: 3, label: 'Ruang Keluarga', topicCtrl: 'coba/lampu3', topicStatus: 'status/lampu3', state: null },
      { id: 4, label: 'Balkon Rumah', topicCtrl: 'coba/lampu4', topicStatus: 'status/lampu4', state: null },
    ];

    const lampuContainer = document.getElementById('lampu-container');
    const connectionDot = document.getElementById('connection-dot');
    const connectionStatus = document.getElementById('connection-status');
    const logEl = document.getElementById('log');

    // Fungsi buat UI tombol dan status tiap lampu
    function createLampuControl(lampu) {
      const div = document.createElement('div');
      div.className = 'lampu-item';

      const label = document.createElement('div');
      label.className = 'lampu-label';
      label.textContent = lampu.label;

      const statusContainer = document.createElement('div');
      statusContainer.className = 'status-container';

      const ledIcon = document.createElement('div');
      ledIcon.className = 'led-icon off';
      ledIcon.id = `led-icon-${lampu.id}`;

      const statusText = document.createElement('div');
      statusText.className = 'status-text';
      statusText.id = `status-${lampu.id}`;
      statusText.textContent = 'Menghubungkan...';

      statusContainer.appendChild(ledIcon);
      statusContainer.appendChild(statusText);

      const btn = document.createElement('button');
      btn.className = 'toggle-btn';
      btn.id = `btn-toggle-${lampu.id}`;
      btn.textContent = '-';
      btn.disabled = true;

      btn.onclick = () => {
        if (!client.connected) {
          addLogEntry(`Error: Tidak terhubung ke broker`, true);
          return;
        }
        const newState = (lampu.state === 'ON') ? '0' : '1';
        client.publish(lampu.topicCtrl, newState);
        addLogEntry(`Mengirim perintah ke ${lampu.label}: ${newState === '1' ? 'NYALA' : 'MATI'}`);
      };

      div.appendChild(label);
      div.appendChild(statusContainer);
      div.appendChild(btn);

      return div;
    }

    // Buat UI semua lampu
    lampus.forEach(l => lampuContainer.appendChild(createLampuControl(l)));

    function addLogEntry(msg, isError = false) {
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      const timeSpan = document.createElement('span');
      timeSpan.className = 'log-time';
      timeSpan.textContent = new Date().toLocaleTimeString();
      
      const msgSpan = document.createElement('span');
      msgSpan.className = 'log-message';
      msgSpan.textContent = msg;
      if (isError) msgSpan.style.color = 'var(--off-state)';
      
      logEntry.appendChild(timeSpan);
      logEntry.appendChild(msgSpan);
      logEl.appendChild(logEntry);
      
      // Batasi jumlah log
      const maxLogEntries = 10;
      if (logEl.children.length > maxLogEntries) {
        logEl.removeChild(logEl.firstChild);
      }

      logEl.scrollTop = logEl.scrollHeight;
    }

    client.on('connect', () => {
      connectionDot.classList.remove('disconnected');
      connectionDot.classList.add('connected');
      connectionStatus.textContent = 'Terhubung ke broker MQTT';
      addLogEntry('✅ Terhubung ke broker MQTT');

      // Subscribe semua topik status lampu
      lampus.forEach(lampu => {
        client.subscribe(lampu.topicStatus, (err) => {
          if (err) {
            addLogEntry(`Gagal subscribe ke ${lampu.topicStatus}`, true);
          }
        });
      });
    });

    client.on('message', (topic, message) => {
      const lampu = lampus.find(l => topic === l.topicStatus);
      if (lampu) {
        const state = message.toString();
        lampu.state = state;
        const ledIcon = document.getElementById(`led-icon-${lampu.id}`);
        const statusText = document.getElementById(`status-${lampu.id}`);
        const btn = document.getElementById(`btn-toggle-${lampu.id}`);

        if (state === '1') {
          ledIcon.classList.add('on');
          ledIcon.classList.remove('off');
          statusText.textContent = 'NYALA';
          statusText.style.color = 'var(--on-state)';
          btn.textContent = 'Matikan';
          btn.disabled = false;
        } else {
          ledIcon.classList.add('off');
          ledIcon.classList.remove('on');
          statusText.textContent = 'MATI';
          statusText.style.color = 'var(--off-state)';
          btn.textContent = 'Nyalakan';
          btn.disabled = false;
        }
      }
    });

    // Fungsi untuk menyimpan jadwal global
    function simpanJadwal() {
      const onTime = document.getElementById("global-on-time").value;
      const offTime = document.getElementById("global-off-time").value;

      if (!onTime || !offTime) {
        alert("Mohon isi waktu ON dan OFF terlebih dahulu!");
        return;
      }

      // Menyimpan ke localStorage
      const jadwalGlobal = { on: onTime, off: offTime };
      localStorage.setItem('jadwalGlobal', JSON.stringify(jadwalGlobal));
      addLogEntry(`Jadwal disimpan: Hidup ${onTime}, Mati ${offTime}`);
    }

    // Mengambil jadwal dari localStorage saat halaman dimuat
    window.onload = () => {
      const savedJadwal = localStorage.getItem('jadwalGlobal');
      if (savedJadwal) {
        const jadwalGlobal = JSON.parse(savedJadwal);
        document.getElementById("global-on-time").value = jadwalGlobal.on;
        document.getElementById("global-off-time").value = jadwalGlobal.off;
      }
    };

    // Penanganan kesalahan koneksi
    client.on('error', (err) => {
      addLogEntry(`❌ Terjadi kesalahan: ${err.message}`, true);
    });

    client.on('offline', () => {
      connectionDot.classList.remove('connected');
      connectionDot.classList.add('disconnected');
      connectionStatus.textContent = 'Koneksi terputus';
      addLogEntry('❌ Koneksi terputus');
      
      // Nonaktifkan tombol saat offline
      lampus.forEach(lampu => {
        const btn = document.getElementById(`btn-toggle-${lampu.id}`);
        if (btn) btn.disabled = true;
      });
    });
  </script>
</body>
</html>